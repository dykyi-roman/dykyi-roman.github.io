<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How to organize application structure - Dykyi Roman</title>
    <link rel="icon" href="../icon.ico" type="image/x-icon">
    <link rel="stylesheet" type="text/css" href="../resources/style.css">
    <link rel="stylesheet" href="../resources/navigation.css">
    <link rel="stylesheet" href="../resources/article-style.css">
</head>
<body>
<div class="container">
    <!-- Include header from external file -->
    <div id="header-container"></div>
    <script>
        fetch('../headers.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
            })
            .catch(error => console.error('Error loading header:', error));
    </script>

    <!-- Article Content -->
    <div class="article-container">
        <div class="article-header">
            <h1 class="article-title">How to organize application structure</h1>
            <img src="img/5.png" alt="How to organize application structure" class="article-featured-img">
        </div>

        <div class="article-content">

            <p><strong>Symfony example:</strong></p>
            <div class="code-block">
<pre>
class Kernel extends \Symfony\Component\HttpKernel\Kernel
{
    use MicroKernelTrait;

    protected function configureRoutes(RoutingConfigurator $routes): void
    {
        $configDir = $this->getConfigDir();
        $routes->import($configDir.'/routes.yaml');

        $this->loadDomainConfigurations($routes);
    }

    protected function loadDomainConfigurations(RoutingConfigurator $routes): void
    {
        $projectDir = $this->getProjectDir();
        $finder = new Finder();
        $finder->directories()
            ->in($projectDir.'/src')
            ->depth(0)
            ->notName('Kernel.php');

        foreach ($finder as $domainDir) {
            $domainPath = $domainDir->getRealPath();
            $domainName = strtolower($domainDir->getBasename());

            // Load API routes
            $apiPath = $domainPath.'/Presentation/Api';
            if (is_dir($apiPath)) {
                $routes->import($apiPath, 'attribute')
                    ->prefix('/'.$domainName);
            } else {
                // Search in subdirectories for API routes
                $subFinder = new Finder();
                $subFinder->directories()
                    ->in($domainPath)
                    ->depth(0);

                foreach ($subFinder as $subFolder) {
                    $apiPath = $domainPath.'/'.$subFolder->getBasename().'/Presentation/Api';
                    if (is_dir($apiPath)) {
                        $routes->import($apiPath, 'attribute')
                            ->prefix('/'.$domainName);
                    }
                }
            }

            // Load Web routes
            $webPath = $domainPath.'/Presentation/Web';
            if (is_dir($webPath)) {
                $routes->import($webPath, 'attribute')
                    ->prefix('/'.$domainName);
            } else {
                // Search in subdirectories for Web routes
                $subFinder = new Finder();
                $subFinder->directories()
                    ->in($domainPath)
                    ->depth(0);

                foreach ($subFinder as $subFolder) {
                    $webPath = $domainPath.'/'.$subFolder->getBasename().'/Presentation/Web';
                    if (is_dir($webPath)) {
                        $routes->import($webPath, 'attribute')
                            ->prefix('/'.$domainName);
                    }
                }
            }

            // Load YAML routes if they exist
            $routesPath = $domainPath.'/Resources/Config/routes.yaml';
            if (file_exists($routesPath)) {
                $routes->import($routesPath);
            } else {
                // Search in subdirectories for routes.yaml
                $subFinder = new Finder();
                $subFinder->directories()
                    ->in($domainPath)
                    ->depth(0);

                foreach ($subFinder as $subFolder) {
                    $routesPath = $domainPath.'/'.$subFolder->getBasename().'/Resources/Config/routes.yaml';
                    if (file_exists($routesPath)) {
                        $routes->import($routesPath);
                    }
                }
            }
        }
    }

    protected function buildContainer(): ContainerBuilder
    {
        $container = parent::buildContainer();

        // Load domain services
        $projectDir = $this->getProjectDir();
        $finder = new Finder();
        $finder->directories()
            ->in($projectDir.'/src')
            ->depth(0)
            ->notName('Kernel.php');

        // Load services
        $loader = new YamlFileLoader($container, new FileLocator());
        foreach ($finder as $domainDir) {
            $domainPath = $domainDir->getRealPath();
            $servicesPath = $domainPath.'/Resources/Config/services.yaml';

            if (file_exists($servicesPath)) {
                $loader->load($servicesPath);
            } else {
                // Search in all subdirectories
                $subFinder = new Finder();
                $subFinder->directories()
                    ->in($domainPath)
                    ->depth(0);

                foreach ($subFinder as $subFolder) {
                    $servicesPath = $domainPath.'/'.$subFolder->getBasename().'/Resources/Config/services.yaml';

                    if (file_exists($servicesPath)) {
                        $loader->load($servicesPath);
                    }
                }
            }
        }

        return $container;
    }
}
</pre>
            </div>

            <p><strong>Laravel example:</strong></p>
            <div class="code-block">
<pre>
final class DomainServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        $this->registerRoutes();
        $this->registerCommands();
    }

    private function registerRoutes(): void
    {
        $presentationPath = dirname(__DIR__).'/Presentation';
        if (!is_dir($presentationPath)) {
            return;
        }

        $this->registerRoutesFromPath($presentationPath);
    }

    private function registerCommands(): void
    {
        $consolePath = dirname(__DIR__).'/Presentation/Console';
        if (!is_dir($consolePath)) {
            return;
        }

        $commands = $this->findCommands($consolePath);
        if (!empty($commands)) {
            $this->commands($commands);
        }
    }

    private function registerRoutesFromPath(string $path): void
    {
        $directory = new \RecursiveDirectoryIterator($path);
        $iterator = new \RecursiveIteratorIterator($directory);
        $files = new \RegexIterator($iterator, '/^.+\.php$/i', \RegexIterator::GET_MATCH);

        foreach ($files as $file) {
            $filePath = $file[0];
            $className = $this->getClassNameFromFile($filePath);

            if (!$className || !class_exists($className)) {
                continue;
            }

            $this->registerClassRoutes($className);
        }
    }

    private function registerClassRoutes(string $className): void
    {
        $reflection = new \ReflectionClass($className);
        $attributes = $reflection->getAttributes(Route::class, \ReflectionAttribute::IS_INSTANCEOF);

        foreach ($attributes as $attribute) {
            $route = $attribute->newInstance();

            LaravelRoute::middleware($route->middleware)
                ->match($route->methods, $route->path, $className)
                ->name($route->name);
        }
    }

    private function findCommands(string $path): array
    {
        $commands = [];

        $directory = new \RecursiveDirectoryIterator($path);
        $iterator = new \RecursiveIteratorIterator($directory);
        $files = new \RegexIterator($iterator, '/^.+Command\.php$/i', \RegexIterator::GET_MATCH);

        foreach ($files as $file) {
            $filePath = $file[0];
            $className = $this->getClassNameFromFile($filePath);

            if ($className && class_exists($className)) {
                $reflection = new \ReflectionClass($className);
                $attributes = $reflection->getAttributes(AsCommand::class);

                if (!empty($attributes)) {
                    $commands[] = $className;
                }
            }
        }

        return $commands;
    }

    private function getClassNameFromFile(string $filePath): ?string
    {
        $content = file_get_contents($filePath);
        if (preg_match('/namespace\s+(.+?);/s', $content, $matches)
            && preg_match('/class\s+(\w+)/', $content, $classMatches)) {
            return $matches[1].'\\'.$classMatches[1];
        }

        return null;
    }
</pre>
            </div>
        </div>
    </div>
</div>
</body>
</html>
